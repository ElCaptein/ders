<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>El Captein V5 - Ã–zet RaporlayÄ±cÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="p-6">

    <div class="max-w-3xl mx-auto mt-10">
        <div class="bg-slate-900 rounded-[2.5rem] p-10 shadow-2xl text-white border border-slate-700">
            <h1 class="text-3xl font-black tracking-tight mb-2">ðŸ“Š ANALÄ°Z SÄ°STEMÄ° <span class="text-emerald-400 text-sm font-normal">v5.0</span></h1>
            <p class="text-slate-400 text-sm mb-8 italic">Ã–ÄŸretmen bazlÄ± Ã¶zet ders daÄŸÄ±lÄ±m raporu oluÅŸturucu</p>
            
            <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 mb-6">
                <input type="file" id="dosya" accept=".xlsx" class="text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-500 file:text-white hover:file:bg-emerald-400 cursor-pointer w-full"/>
            </div>

            <button onclick="raporOlustur()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-5 rounded-2xl font-black uppercase tracking-tighter shadow-lg transition-all active:scale-95">
                Raporu Analiz Et ve Excel'i Ä°ndir
            </button>
        </div>
        <div id="bilgi" class="mt-6 text-center text-slate-500 font-medium"></div>
    </div>

    <script>
        const gunler = ["Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma"];

        async function raporOlustur() {
            const input = document.getElementById('dosya');
            if(!input.files[0]) return alert("Dosya seÃ§iniz!");

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                
                const ogSheet = wb.Sheets["Ã–ÄŸretmen ProgramlarÄ±"];
                const snSheet = wb.Sheets["SÄ±nÄ±f ProgramlarÄ±"];
                
                const ogRows = XLSX.utils.sheet_to_json(ogSheet, {header: 1});
                const snRows = snSheet ? XLSX.utils.sheet_to_json(snSheet, {header: 1}) : [];

                let hocaVerileri = {};
                let genelDersOzetSet = new Set(); // TekilleÅŸtirme iÃ§in Set kullanÄ±yoruz

                let aktifHoca = null;

                // VERÄ°LERÄ° TARA VE ANALÄ°Z ET
                ogRows.forEach(row => {
                    if(!row || row.length === 0) return;
                    let ilk = String(row[0]);

                    if(ilk.includes("(") && !ilk.includes("SAAT")) {
                        aktifHoca = ilk.split("(")[0].trim();
                        hocaVerileri[aktifHoca] = {
                            full: ilk,
                            program: [["SAAT", ...gunler]],
                            saatSayisi: 0
                        };
                    } else if(aktifHoca && !isNaN(parseInt(ilk)) && parseInt(ilk) < 12) {
                        hocaVerileri[aktifHoca].program.push(row);
                        for(let i=1; i<=5; i++) {
                            if(row[i] && row[i] !== "-") {
                                hocaVerileri[aktifHoca].saatSayisi++;
                                // "Hoca - SÄ±nÄ±f - Ders" kombinasyonunu tekilleÅŸtir
                                const parca = row[i].split(" - ");
                                const sinif = parca[0] || "?";
                                const ders = parca[1] || "?";
                                genelDersOzetSet.add(`${aktifHoca}|${sinif}|${ders}`);
                            }
                        }
                    }
                });

                // Set'i tabloya dÃ¶nÃ¼ÅŸtÃ¼r
                let ozetTablo = [["Ã–ÄžRETMEN ADI", "SINIF", "DERS"]];
                Array.from(genelDersOzetSet).sort().forEach(item => {
                    ozetTablo.push(item.split("|"));
                });

                excelDosyaHazirla(snRows, hocaVerileri, ozetTablo);
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function excelDosyaHazirla(snRows, hocaData, ozetTablo) {
            const outWb = XLSX.utils.book_new();

            // 1. SÄ±nÄ±f ProgramlarÄ± (OlduÄŸu gibi)
            XLSX.utils.book_append_sheet(outWb, XLSX.utils.aoa_to_sheet(snRows), "SINIF PROGRAMLARI");

            // 2. Her Ã–ÄŸretmen Sekmesi
            Object.keys(hocaData).sort().forEach(hAd => {
                const h = hocaData[hAd];
                const maas = 15;
                const ekders = Math.max(0, h.saatSayisi - maas);

                const sheetContent = [
                    [h.full],
                    ["TOPLAM DERS:", h.saatSayisi, "MAAÅž:", maas, "EK DERS:", ekders],
                    [],
                    ["ðŸ“… HAFTALIK PROGRAM"],
                    ...h.program,
                    [],
                    ["---------------------------------------------------"],
                    ["ðŸ“¢ OKUL GENELÄ° DERS DAÄžILIM LÄ°STESÄ° (Ã–ZET)"],
                    ["(Hangi Ã¶ÄŸretmen hangi sÄ±nÄ±fa giriyor?)"],
                    [],
                    ...ozetTablo // TEKRARSIZ Ã–ZET LÄ°STE
                ];

                const ws = XLSX.utils.aoa_to_sheet(sheetContent);
                const safeName = hAd.replace(/[\\*?:/\[\]]/g, "").substring(0, 31);
                XLSX.utils.book_append_sheet(outWb, ws, safeName);
            });

            XLSX.writeFile(outWb, "Program_Analiz_Raporu_Ozet.xlsx");
            document.getElementById('bilgi').innerText = "âœ… Rapor HazÄ±r!";
        }
    </script>
</body>
</html>
